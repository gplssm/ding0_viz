<style>
  #map {
    height: 800px;
  }

  .mt-0 {
  margin-top: 10 !important;
  }
    
</style>


<div class="container-fluid" style="width: 100%">
  <div class="row my-sm-2">
    <div class="col-sm mx-auto" id="map"></div>
    <div class="col-sm-3 mx-auto">
      <div class="row" id="district">
        <p style="height: 350px">
        </p>
      </div>
      <div class="row" id="info">
      </div>
    </div>

  </div>
</div>

<script type="text/javascript" src="js/backgroundmap.js"></script>  

<script>
  mv_grid_district_id = "{{ site.mv_grid_district_id }}"
  var district = d3.select("#district")
      .append("div")
      .attr("class", "p")
      .style("visibility", "visible");
  d3.json("data/mv_grid_district_" + mv_grid_district_id + ".geojson", function(d) {
    props = d.features[0].properties;
      district
        .html("<h3>Medium-voltage grid district {{ site.mv_grid_district_id }}</h3><p>Area: " + props.area_ha + " ha</p><p>Inhabitants: " + props.zensus_sum + "</p><p>Consumption: " + props.consumption + " MWh/a</p>");
  });

  backgroundmap(mv_grid_district_id);

  function plot_nodes(node_data) {

    // Add an SVG element to Leafletâ€™s overlay pane
    var svg = d3.select(map.getPanes().overlayPane).append("svg")
    var g = svg.append("g").attr("class", "leaflet-zoom-hide");
    var map_lines = svg.append("g").attr("id", "lines");
    var map_points = svg.append("g").attr("id", "points");

    var transform = d3.geoTransform({point: projectPoint}),
    path = d3.geoPath().projection(transform);

    map.on('moveend', mapmove);

    redrawSubset(node_data.features)

    function redrawSubset(subset) {
      path.pointRadius(12);

      var bounds = path.bounds({
        type: "FeatureCollection",
        features: subset
      });

      var offset = 500;
      var topLeft = bounds[0] + offset;
      var bottomRight = [bounds[1][0] + offset, bounds[1][1] + offset];


      svg.attr("width", bottomRight[0] - topLeft[0])
        .attr("height", bottomRight[1] - topLeft[1])
        .style("left", topLeft[0] + "px")
        .style("top", topLeft[1] + "px");


      map_points.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
      // map_lines.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");

    // Create Infobox
    var Info = d3.select("#info")
      .append("div")
      .attr("class", "p")
      .style("visibility", "hidden");

    // Plot nodes
    // // Filter data
    hvmv_trafos = subset.filter( function(d){return d.properties.v_nom == 110} )
    mvlv_trafos = subset.filter( function(d){return d.properties.v_nom == 400} )

    color = {"hvmv": "#ff8800", "mvlv": "#008db7"}

    function plot_points(subset, color) {
      var points = map_points.selectAll("path")
      .data(subset, function(d) {
        return d.geometry.coordinates;
      })
      .style("pointer-events", "all")
      .attr("fill", color)
      // .attr("class", "map_points")
      .on("mouseover", function (d) {
        Info.style("visibility", "visible")
        .html("<h5>" + d.properties.name + "</h5> <p>Nominal voltage: " + d.properties.v_nom + " kV</p>");
        d3.select(this)
          .transition()
          .duration(200)
          .style("fill-opacity", ".7");
      })
      .on('mouseout', function() {                              
          Info.style('visibility', 'hidden');
          d3.select(this)
            .transition()
            .duration(200)
            .style("fill-opacity", "1")
        });  

    points.enter().append("path");

    points.attr("d", path).attr("class", "points");
    }


    plot_points(hvmv_trafos, color["hvmv"]);
    plot_points(mvlv_trafos, color["mvlv"]);

    }
    function plot_lines(lines_data) {
                    // console.log(lines.features[0].geometry.coordinates[0], lines.features[0].geometry.coordinates[1])
                    // console.log(path(lines.features[0].geometry.coordinates))
      console.log(lines_data.features);
      edges = map_lines.selectAll("path")
                    .data(lines_data.features)
                    .enter()
                    .append("path")
                    .attr("d", function(d){
                      // console.log(d.geometry.coordinates[0]); console.log(path(d)); 
                      return path(d)})
                    .attr("class", "lines")
                    .style("fill", "#9c9c9c")
        .style("stroke", "#9c9c9c")
        .style("stroke-width", 5);

        return lines_data;
    }

    lines_data = d3.json("data/ding0/{{ site.mv_grid_district_id }}/mv_visualization_line_data_{{ site.mv_grid_district_id }}.geojson", plot_lines)                
    mapmove();

    function mapmove(e) {
        //remove all points
        d3.selectAll(".points").remove();
        d3.selectAll(".lines").remove();
        redrawSubset(node_data.features);
        plot_lines(lines_data);
  }
      
};

d3.json("data/ding0/{{ site.mv_grid_district_id }}/mv_visualization_node_data_{{ site.mv_grid_district_id }}.geojson", plot_nodes)



function projectPoint(x, y) {
      var point = map.latLngToLayerPoint(new L.LatLng(y, x));
      this.stream.point(point.x, point.y);
    }
</script>