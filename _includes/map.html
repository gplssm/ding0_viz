<style>
  #map {
    height: 800px;
  }

  .mt-0 {
  margin-top: 10 !important;
  }

  path {
      fill: #008d7f;
      fill-opacity: 1;
    }
    
</style>


<div class="container-fluid" style="width: 100%">
  <div class="row my-sm-2">
    <div class="col-sm mx-auto" id="map"></div>
    <div class="col-sm-3 mx-auto">
      <div class="row" id="district">
        <p style="height: 350px">
        </p>
      </div>
      <div class="row" id="info">
      </div>
    </div>

  </div>
</div>

<script type="text/javascript" src="js/backgroundmap.js"></script>  

<script>
  mv_grid_district_id = "{{ site.mv_grid_district_id }}"
  var district = d3.select("#district")
      .append("div")
      .attr("class", "p")
      .style("visibility", "visible");
  d3.json("data/mv_grid_district_" + mv_grid_district_id + ".geojson", function(d) {
    props = d.features[0].properties;
      district
        .html("<h3>Medium-voltage grid district {{ site.mv_grid_district_id }}</h3><p>Area: " + props.area_ha + " ha</p><p>Inhabitants: " + props.zensus_sum + "</p><p>Consumption: " + props.consumption + " MWh/a</p>");
  });

  backgroundmap(mv_grid_district_id);
  // console.log(shape)

  function plot_nodes(node_data) {

    // Add an SVG element to Leafletâ€™s overlay pane
    var svg = d3.select(map.getPanes().overlayPane).append("svg"),
      g = svg.append("g").attr("class", "leaflet-zoom-hide");

    var transform = d3.geoTransform({point: projectPoint}),
    path = d3.geoPath().projection(transform);

    map.on('moveend', mapmove);

    redrawSubset(node_data.features)

    function redrawSubset(subset) {
      path.pointRadius(10);

      var bounds = path.bounds({
        type: "FeatureCollection",
        features: subset
      });

      var offset = 10;
      var topLeft = bounds[0] + offset;
      var bottomRight = [bounds[1][0] + offset, bounds[1][1] + offset];


      svg.attr("width", bottomRight[0] - topLeft[0])
        .attr("height", bottomRight[1] - topLeft[1])
        .style("left", topLeft[0] + "px")
        .style("top", topLeft[1] + "px");


      g.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");

      var start = new Date();

    // Create Infobox
    var Info = d3.select("#info")
      .append("div")
      .attr("class", "p")
      .style("visibility", "hidden");

    // Plot nodes
    var points = g.selectAll("path")
      .data(subset, function(d) {
        return d.geometry.coordinates;
      })
      .style("pointer-events", "all")
      .on("mouseover", function (d) {
        Info.style("visibility", "visible")
        .html("<h5>" + d.properties.name + "</h5> <br></br>Nominal voltage: " + d.properties.v_nom + " kV");
      })
      .on('mouseout', function() {                              
          Info.style('visibility', 'hidden');
        });  

    points.enter().append("path");

    points.attr("d", path).attr("class", "points");

    }
    mapmove();

      function mapmove(e) {
        //remove all points
        d3.selectAll(".points").remove();
        redrawSubset(node_data.features);
      }
  }

d3.json("data/ding0/{{ site.mv_grid_district_id }}/mv_visualization_data_{{ site.mv_grid_district_id }}.geojson", plot_nodes)

function projectPoint(x, y) {
      var point = map.latLngToLayerPoint(new L.LatLng(y, x));
      this.stream.point(point.x, point.y);
    }
</script>